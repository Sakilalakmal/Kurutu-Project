generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                     String             @id
  name                   String
  email                  String             @unique
  emailVerified          Boolean            @default(false)
  image                  String?
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  accounts               Account[]
  sessions               Session[]
  diagrams               Diagram[]
  chatMessages           ChatMessage[]
  createdWorkspaces      Workspace[]        @relation("WorkspaceCreatedBy")
  workspaceMembers       WorkspaceMember[]
  createdWorkspaceInvites WorkspaceInvite[] @relation("WorkspaceInviteCreatedBy")
  workspaceActivities    WorkspaceActivity[] @relation("WorkspaceActivityActorUser")

  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

model Diagram {
  id          String     @id @default(cuid())
  userId      String
  workspaceId String?
  title       String     @default("Untitled Diagram")
  isPublic    Boolean    @default(false)
  data        Json
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace   Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
  chatThreads ChatThread[]
  activities  WorkspaceActivity[]

  @@index([userId])
  @@index([workspaceId])
  @@index([workspaceId, updatedAt(sort: Desc)])
  @@index([userId, updatedAt(sort: Desc)])
}

enum WorkspaceMemberRole {
  OWNER
  EDITOR
  VIEWER
}

enum WorkspaceInviteRole {
  EDITOR
  VIEWER
}

enum ChatThreadType {
  WORKSPACE_GENERAL
  DIAGRAM
}

enum ActionType {
  DIAGRAM_CREATE
  DIAGRAM_UPDATE
  NODE_CREATE
  NODE_UPDATE
  NODE_DELETE
  EDGE_CREATE
  EDGE_UPDATE
  EDGE_DELETE
  FIELD_ADD
  FIELD_UPDATE
  FIELD_DELETE
  INVITE_CREATE
  INVITE_REVOKE
  MEMBER_JOIN
  MEMBER_ROLE_CHANGE
  MEMBER_REMOVE
}

enum EntityType {
  WORKSPACE
  DIAGRAM
  NODE
  EDGE
  FIELD
  INVITE
  MEMBER
}

model Workspace {
  id              String            @id @default(cuid())
  name            String
  slug            String?           @unique
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  createdByUserId String
  createdBy       User              @relation("WorkspaceCreatedBy", fields: [createdByUserId], references: [id], onDelete: Cascade)
  members         WorkspaceMember[]
  invites         WorkspaceInvite[]
  diagrams        Diagram[]
  chatThreads     ChatThread[]
  chatMessages    ChatMessage[]
  activities      WorkspaceActivity[]

  @@index([createdByUserId])
}

model WorkspaceMember {
  id          String              @id @default(cuid())
  workspaceId String
  userId      String
  role        WorkspaceMemberRole
  joinedAt    DateTime            @default(now())
  workspace   Workspace           @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([workspaceId, role])
  @@index([userId])
}

model WorkspaceInvite {
  id              String              @id @default(cuid())
  workspaceId     String
  token           String              @unique
  role            WorkspaceInviteRole
  createdByUserId String
  createdAt       DateTime            @default(now())
  expiresAt       DateTime?
  maxUses         Int?
  usesCount       Int                 @default(0)
  revokedAt       DateTime?
  workspace       Workspace           @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdBy       User                @relation("WorkspaceInviteCreatedBy", fields: [createdByUserId], references: [id], onDelete: Cascade)

  @@index([workspaceId, revokedAt])
  @@index([createdByUserId])
}

model ChatThread {
  id          String         @id @default(cuid())
  workspaceId String
  type        ChatThreadType
  diagramId   String?
  title       String
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  workspace   Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  diagram     Diagram?       @relation(fields: [diagramId], references: [id], onDelete: Cascade)
  messages    ChatMessage[]

  @@unique([workspaceId, diagramId])
  @@index([workspaceId, type])
  @@index([workspaceId, updatedAt(sort: Desc)])
  @@index([diagramId])
}

model ChatMessage {
  id           String     @id @default(cuid())
  threadId     String
  workspaceId  String
  senderUserId String
  clientMessageId String?
  content      String
  createdAt    DateTime   @default(now())
  editedAt     DateTime?
  deletedAt    DateTime?
  thread       ChatThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  workspace    Workspace  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  sender       User       @relation(fields: [senderUserId], references: [id], onDelete: Cascade)

  @@index([threadId, createdAt])
  @@index([workspaceId, createdAt(sort: Desc)])
  @@index([senderUserId, createdAt(sort: Desc)])
  @@unique([senderUserId, clientMessageId])
}

model WorkspaceActivity {
  id          String     @id @default(cuid())
  workspaceId String
  diagramId   String?
  actorUserId String
  actionType  ActionType
  entityType  EntityType
  entityId    String?
  summary     String
  metadata    Json?
  createdAt   DateTime   @default(now())
  workspace   Workspace  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  diagram     Diagram?   @relation(fields: [diagramId], references: [id], onDelete: SetNull)
  actorUser   User       @relation("WorkspaceActivityActorUser", fields: [actorUserId], references: [id], onDelete: Cascade)

  @@index([workspaceId, createdAt(sort: Desc)])
  @@index([workspaceId, diagramId, createdAt(sort: Desc)])
}
